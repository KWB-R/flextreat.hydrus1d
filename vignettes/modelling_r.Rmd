---
title: "Modelling with R"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Modelling with R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
is_windows <- .Platform$OS.type == "windows"
```

This workflow is based on using the R package [kwb.hydrus1d](https://kwb-r.github.io/kwb.hydrus1d/), which is compatible with 
the last official release of [HYDRUS1D v4.17.0140](https://www.pc-progress.com/en/Default.aspx?H1d-downloads). The 
development of this new `R package` was necessary, due to the fact that already 
available model wrappers were developed for outdated `HYDRUS1D` versions (e.g. 
python package [phydrus](https://github.com/phydrus/phydrus) requires [HYDRUS1D v4.08](https://github.com/phydrus/source_code/issues/1#issuecomment-1034675697)) 
and/or are not well maintained (e.g. open issues/pull requests for R package 
[hydrusR](https://github.com/shoebodh/hydrusR)). 

The workflow below describes all the steps required for:

1. **Modifying** (i.e. `atmospheric` input data defined in file `ATMOSPHERE.in`) 
an already pre-prepared `HYDRUS1D` model (using the `HYDRUS1D GUI`)

2. **Running** it from within `R`  by using the command line (`cmd`) and 

3. **Importing** and **analysing** the `HYDRUS1D` results within R.



## Install R Package

```{r eval=FALSE}
# Enable this universe
options(repos = c(
  kwbr = 'https://kwb-r.r-universe.dev',
  CRAN = 'https://cloud.r-project.org'))
# Install R package
install.packages('flextreat.hydrus1d')
```

## Define Paths

```{r define_paths, eval=is_windows}
paths_list <- list(
  exe_dir = system.file("extdata/model", package = "flextreat.hydrus1d"),
  model_name = "test",
  model_dir = "<exe_dir>/<model_name>",
  atmosphere = "<model_dir>/ATMOSPH.IN",
  a_level = "<model_dir>/A_LEVEL.out",
  t_level = "<model_dir>/T_LEVEL.out",
  runinf = "<model_dir>/Run_Inf.out"
)

paths <- kwb.utils::resolve(paths_list)


```

## Prepare Input

### Soil Data

```{r prepare_soils, eval=TRUE}
library(flextreat.hydrus1d)
### Test ROSETTA pedotransfer function 
soilDB::ROSETTA(x = data.frame(sand = rep(93.5,4), 
                               silt = rep(6.4,4), 
                               clay = rep(0.1,4)),
                 vars = c("sand", "silt", "clay"), 
                v = "3")
```

### Atmospheric Boundary Conditons

```{r prepare_atmosphere, eval=is_windows}

atm <- flextreat.hydrus1d::prepare_atmosphere_data()
atm_selected <- flextreat.hydrus1d::select_hydrologic_years(atm)
atm_prep <- flextreat.hydrus1d::prepare_atmosphere(atm_selected)


atmos <- kwb.hydrus1d::write_atmosphere(atm = atm_prep,
                                        MaxAL = nrow(atm_prep))

writeLines(atmos, paths$atmosphere)
```

## Run Model

```{r run_model, eval=is_windows}
exe_path <- kwb.hydrus1d::check_hydrus_exe(dir = paths$exe_dir,
                                           skip_preinstalled = TRUE)
kwb.hydrus1d:::run_model(exe_path = exe_path,
                         model_path = paths$model_dir)

```

## Read Results

```{r read_results, eval=is_windows}

a_level <- kwb.hydrus1d::read_alevel(paths$a_level)
a_level

t_level <- kwb.hydrus1d::read_tlevel(paths$t_level)
t_level

runinf <- kwb.hydrus1d::read_runinf(paths$runinf)
runinf
```

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Modelling with R: Scenario Analysis • flextreat.hydrus1d</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Modelling with R: Scenario Analysis">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flextreat.hydrus1d</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/modelling_no-irrigation.html">Modelling with R: No Irrigation (2017-05-01 - 2020-10-31)</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_r.html">Modelling with R: Status Quo (2017-05-01 - 2020-10-31)</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_scenarios.html">Modelling with R: Scenario Analysis</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/KWB-R/flextreat.hydrus1d/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="modelling_scenarios_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="modelling_scenarios_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="modelling_scenarios_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="modelling_scenarios_files/datatables-binding-0.33/datatables.js"></script><link href="modelling_scenarios_files/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="modelling_scenarios_files/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="modelling_scenarios_files/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="modelling_scenarios_files/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="modelling_scenarios_files/crosstalk-1.2.1/js/crosstalk.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Modelling with R: Scenario Analysis</h1>
                        <h4 data-toc-skip class="author">Michael
Rustler</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/KWB-R/flextreat.hydrus1d/blob/master/vignettes/modelling_scenarios.Rmd" class="external-link"><code>vignettes/modelling_scenarios.Rmd</code></a></small>
      <div class="d-none name"><code>modelling_scenarios.Rmd</code></div>
    </div>

    
    
<p>The HYDRUS-1D model developed within the <a href="https://kwb-r.github.io/flextreat.hydrus1d/articles/modelling_r.html">Modelling
R: Status Quo (2017-05-01 - 2020-10-31)</a> workflow as updated and
extended for a longer time period, i.e. 2017-05-01 - 2023-12-31. This
model serves now as reference scenario for the later calculations and
its input data files were added to this R package in the folder
<code>extdata/model/model_to_copy</code>.</p>
<p>The idea was to copy the base scenario input data structure, and
modify only the required input data for each scenario. Please note that
the calculation of all scenarios requires a lot of hard disk space (~
600 GB) and may an additional external hard disk. In addition the
calculation time for all scenarios will be several days in case of
single core calculation, which reduces approximately linearly if more
cores are used. However, there might be cases (calculation errors on
some nodes during parallel computing) which could require to switch to
single core computation.</p>
<div class="section level2">
<h2 id="install-r-package">Install R Package<a class="anchor" aria-label="anchor" href="#install-r-package"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Enable this universe</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  kwbr <span class="op">=</span> <span class="st">'https://kwb-r.r-universe.dev'</span>,</span>
<span>  CRAN <span class="op">=</span> <span class="st">'https://cloud.r-project.org'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Install R package</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'flextreat.hydrus1d'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-paths">Define Paths<a class="anchor" aria-label="anchor" href="#define-paths"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">root_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_math.html" class="external-link">path_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">dir_copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/model/model_to_copy"</span>, package <span class="op">=</span> <span class="st">"flextreat.hydrus1d"</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root_dir</span>, <span class="st">"model_to_copy"</span><span class="op">)</span>,</span>
<span>             overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">provide_paths</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">root_dir</span>, <span class="va">config</span>, <span class="va">start</span>, <span class="va">end</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#Y:\WWT_Department\Projects\FlexTreat\Work-packages\AP3\3_1_4_Prognosemodell\Hydrus1D\irrig_fixed\irrig-period_status-quo\long_dry\retardation_no</span></span>
<span>  <span class="va">tracer</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">treatment</span> <span class="op">==</span> <span class="st">"tracer"</span></span>
<span>  <span class="co"># Define a path grammar</span></span>
<span>  <span class="va">PATH_GRAMMAR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    exe_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s/&lt;irrig_dir_string&gt;/&lt;duration_string&gt;&lt;extreme_rain_string&gt;/%s"</span>, <span class="va">root_dir</span>, <span class="va">config</span><span class="op">$</span><span class="va">retardation_scenario</span><span class="op">)</span>,</span>
<span>    model_name_org <span class="op">=</span> <span class="st">"model_to_copy"</span>,</span>
<span>    model_name <span class="op">=</span> <span class="st">"&lt;location&gt;_&lt;scenario&gt;_soil-column_&lt;solute_id_start&gt;&lt;solute_id_end&gt;"</span>,</span>
<span>    <span class="co">###model_gui_path_org =  "&lt;exe_dir&gt;/&lt;model_name_org&gt;.h1d",</span></span>
<span>    model_gui_path_org <span class="op">=</span>  <span class="st">"&lt;model_dir_org&gt;/&lt;model_name_org&gt;.h1d"</span>,</span>
<span></span>
<span>    model_gui_path <span class="op">=</span> <span class="st">"&lt;exe_dir&gt;/&lt;model_name&gt;.h1d"</span>,</span>
<span>    modelvs_gui_path <span class="op">=</span> <span class="st">"&lt;exe_dir&gt;/&lt;model_name&gt;_vs.h1d"</span>,</span>
<span></span>
<span>    model_dir_org <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s/&lt;model_name_org&gt;"</span>, <span class="va">root_dir</span><span class="op">)</span>,</span>
<span></span>
<span>    model_dir <span class="op">=</span> <span class="st">"&lt;exe_dir&gt;/&lt;model_name&gt;"</span>,</span>
<span>    model_dir_vs <span class="op">=</span> <span class="st">"&lt;exe_dir&gt;/&lt;model_name&gt;_vs"</span>,</span>
<span>    atmosphere <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/ATMOSPH.IN"</span>,</span>
<span>    atmosphere_vs <span class="op">=</span> <span class="st">"&lt;model_dir_vs&gt;/ATMOSPH.IN"</span>,</span>
<span>    a_level <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/A_LEVEL.out"</span>,</span>
<span>    hydrus1d <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/HYDRUS1D.DAT"</span>,</span>
<span>    selector <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/SELECTOR.IN"</span>,</span>
<span>    profile <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/PROFILE.DAT"</span>,</span>
<span>    obs_node <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/Obs_Node.out"</span>,</span>
<span>    balance <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/BALANCE.out"</span>,</span>
<span>    t_level <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/T_LEVEL.out"</span>,</span>
<span>    t_level_vs <span class="op">=</span> <span class="st">"&lt;model_dir_vs&gt;/T_LEVEL.out"</span>,</span>
<span>    runinf <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/Run_Inf.out"</span>,</span>
<span>    solute_id <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>    solute <span class="op">=</span> <span class="st">"&lt;model_dir&gt;/solute&lt;solute_id&gt;.out"</span>,</span>
<span>    solute_vs <span class="op">=</span> <span class="st">"&lt;model_dir_vs&gt;/solute&lt;solute_id&gt;.out"</span>,</span>
<span>    soil_data <span class="op">=</span> <span class="st">"&lt;extdata&gt;/input-data/soil/soil_geolog.csv"</span>,</span>
<span>    solute_id_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%02d"</span>, <span class="va">start</span><span class="op">)</span>,</span>
<span>    solute_id_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%02d"</span>, <span class="va">end</span><span class="op">)</span>,</span>
<span>    location <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">tracer</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">"tracer"</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"ablauf_%s_median"</span>, <span class="va">config</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="co">#"ablauf_ka_median"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Resolve the path grammar by replacing the placeholders recursively</span></span>
<span>  <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/resolve.html" class="external-link">resolve</a></span><span class="op">(</span></span>
<span>    <span class="va">PATH_GRAMMAR</span>,</span>
<span>    irrig_dir_string <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="va">config</span><span class="op">$</span><span class="va">irrig_only_growing_season</span>,</span>
<span>      <span class="st">"irrig-period_growing-season"</span>,</span>
<span>      <span class="st">"irrig-period_status-quo"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    duration_string <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">duration_string</span>,</span>
<span>    extreme_rain_string <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">extreme_rain</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="va">config</span><span class="op">$</span><span class="va">extreme_rain</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="st">""</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="co">#final_subdir = ifelse(tracer, "tracer", config$retardation_scenario),</span></span>
<span>    scenario <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">scenario</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="provide-helper-functions">Provide Helper Functions<a class="anchor" aria-label="anchor" href="#provide-helper-functions"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KWB-R/flextreat.hydrus1d" class="external-link">flextreat.hydrus1d</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get_atm ----------------------------------------------------------------------</span></span>
<span><span class="va">get_atm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">atm</span>, <span class="va">extreme_rain</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">`%&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va">`%&gt;%`</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">extreme_rain</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">atm</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">extreme_rain</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dry"</span>, <span class="st">"wet"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"extreme_rain has to be either 'NULL', 'dry' or 'wet"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">atm</span> <span class="op">&lt;-</span> <span class="va">atm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      hydrologic_year <span class="op">=</span> <span class="fu">flextreat.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="../reference/get_hydrologic_years.html">get_hydrologic_years</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>      year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date</span>, format <span class="op">=</span> <span class="st">"%Y"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      day_of_year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">yday</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="va">atm_stats</span> <span class="op">&lt;-</span> <span class="va">atm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      rain_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">rain_mm</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      evapo_p_mean_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">evapo_p_mean_mm</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">extreme_rain</span> <span class="op">==</span> <span class="st">"dry"</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">atm_dry</span> <span class="op">&lt;-</span> <span class="va">atm_stats</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rain_mm</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rain_mm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">atm_dry_sel</span> <span class="op">&lt;-</span> <span class="va">atm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="va">atm_dry</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">day_of_year</span>, <span class="va">rain_mm</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">atm_dry_input</span> <span class="op">&lt;-</span> <span class="va">atm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">rain_mm</span>, <span class="op">-</span> <span class="va">hydrologic_year</span>, <span class="op">-</span> <span class="va">year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">atm_dry_sel</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rain_mm <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">rain_mm</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">rain_mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">day_of_year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">rain_mm</span>, .after <span class="op">=</span> <span class="va">clearwater.mmPerDay</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">atm_dry_input</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">extreme_rain</span> <span class="op">==</span> <span class="st">"wet"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">atm_wet</span> <span class="op">&lt;-</span> <span class="va">atm_stats</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rain_mm</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rain_mm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">atm_wet_sel</span> <span class="op">&lt;-</span> <span class="va">atm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="va">atm_wet</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">day_of_year</span>, <span class="va">rain_mm</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">atm_wet_input</span> <span class="op">&lt;-</span> <span class="va">atm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">rain_mm</span>, <span class="op">-</span> <span class="va">hydrologic_year</span>, <span class="op">-</span> <span class="va">year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">atm_wet_sel</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rain_mm <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">rain_mm</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">rain_mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">day_of_year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">rain_mm</span>, .after <span class="op">=</span> <span class="va">clearwater.mmPerDay</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">atm_wet_input</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># prepare_solute_input ---------------------------------------------------------</span></span>
<span><span class="va">prepare_solute_input</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">dat</span>,</span>
<span>    <span class="va">selector</span>,</span>
<span>    <span class="va">Ks</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">SnkL1</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">diff_w</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">diff_g</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">kd</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">halftime_to_firstorderrate</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">`%&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va">`%&gt;%`</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">selector</span><span class="op">$</span><span class="va">solute</span><span class="op">$</span><span class="va">No.Solutes</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">selector</span><span class="op">$</span><span class="va">solute</span><span class="op">$</span><span class="va">No.Solutes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">solute_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"solute_%d"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">solutes_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">solute_names</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">dat_sel</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span></span>
<span></span>
<span>    <span class="va">ks</span> <span class="op">&lt;-</span> <span class="fu">kd</span><span class="op">(</span></span>
<span>      porosity <span class="op">=</span> <span class="va">selector</span><span class="op">$</span><span class="va">waterflow</span><span class="op">$</span><span class="va">soil</span><span class="op">$</span><span class="va">ths</span> <span class="op">-</span> <span class="va">selector</span><span class="op">$</span><span class="va">waterflow</span><span class="op">$</span><span class="va">soil</span><span class="op">$</span><span class="va">thr</span>,</span>
<span>      retardation <span class="op">=</span> <span class="va">dat_sel</span><span class="op">$</span><span class="va">retard</span>,</span>
<span>      bulk_density <span class="op">=</span> <span class="va">selector</span><span class="op">$</span><span class="va">solute</span><span class="op">$</span><span class="va">transport</span><span class="op">$</span><span class="va">Bulk.d.</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Ks"</span>, <span class="st">"Nu"</span>, <span class="st">"Beta"</span>, <span class="st">"Henry"</span>, <span class="st">"SnkL1"</span>, <span class="st">"SnkS1"</span>, <span class="st">"SnkG1"</span>, <span class="st">"SnkL1'"</span>,</span>
<span>      <span class="st">"SnkS1'"</span>, <span class="st">"SnkG1'"</span>, <span class="st">"SnkL0"</span>,  <span class="st">"SnkS0"</span>, <span class="st">"SnkG0"</span>,  <span class="st">"Alfa"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">reaction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fl">0</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ks</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">reaction</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cols</span></span>
<span>    <span class="va">reaction</span><span class="op">$</span><span class="va">Beta</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span>    <span class="va">reaction</span><span class="op">$</span><span class="va">Ks</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">Ks</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ks</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">Ks</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">reaction</span><span class="op">$</span><span class="va">SnkL1</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">SnkL1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu">halftime_to_firstorderrate</span><span class="op">(</span><span class="va">dat_sel</span><span class="op">$</span><span class="va">half_life_days</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">SnkL1</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      diffusion <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>DifW <span class="op">=</span> <span class="va">diff_w</span>, DifG <span class="op">=</span> <span class="va">diff_g</span><span class="op">)</span>,</span>
<span>      reaction <span class="op">=</span> <span class="va">reaction</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sel_tmp</span> <span class="op">&lt;-</span> <span class="va">selector</span><span class="op">$</span><span class="va">solute</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">selector</span><span class="op">$</span><span class="va">solute</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">solute_names</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">solutes_new_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">sel_tmp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sel_tmp</span><span class="op">)</span> <span class="op">==</span> <span class="st">"transport"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    <span class="va">solutes_new</span>,</span>
<span>    <span class="va">sel_tmp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sel_tmp</span><span class="op">)</span> <span class="op">==</span> <span class="st">"kTopSolute"</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sel_tmp</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">selector</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">selector</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"solute"</span><span class="op">]</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>solute <span class="op">=</span> <span class="va">solutes_new_list</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># get_mean ---------------------------------------------------------------------</span></span>
<span><span class="va">get_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">col</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split_fixed</a></span><span class="op">(</span><span class="va">col</span>, <span class="st">"-"</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mode.html" class="external-link">mode</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"numeric"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># kd ---------------------------------------------------------------------------</span></span>
<span><span class="va">kd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">porosity</span>, <span class="va">retardation</span>, <span class="va">bulk_density</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#https://www3.epa.gov/ceampubl/learn2model/part-two/onsite/retard.html</span></span>
<span>  <span class="op">(</span><span class="va">retardation</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">porosity</span> <span class="op">/</span> <span class="va">bulk_density</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># halftime_to_firstorderrate ---------------------------------------------------</span></span>
<span><span class="va">halftime_to_firstorderrate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">half_time</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">half_time</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">#https://chem.libretexts.org/Courses/Bellarmine_University/BU%3A_Chem_104_(Christianson)/Phase_2%3A_Understanding_Chemical_Reactions/4%3A_Kinetics%3A_How_Fast_Reactions_Go/4.5%3A_First_Order_Reaction_Half-Life#mjx-eqn-21.4.2</span></span>
<span>    <span class="fl">0.693</span> <span class="op">/</span> <span class="va">half_time</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># provide_soil_columns ---------------------------------------------------------</span></span>
<span><span class="va">provide_soil_columns</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">`%&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va">`%&gt;%`</span></span>
<span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">openxlsx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/read.xlsx.html" class="external-link">read.xlsx</a></span><span class="op">(</span><span class="va">path</span>, namedRegion <span class="op">=</span> <span class="st">"my_results2"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html" class="external-link">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>substanz_name <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_trim</a></span><span class="op">(</span><span class="va">substanz_name</span><span class="op">)</span>,</span>
<span>                  half_life_days <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"&gt;"</span>, <span class="va">hwz_tage</span><span class="op">)</span> <span class="op">~</span> <span class="va">hwz_tage</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="st">"&gt;"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"&lt;"</span>, <span class="va">hwz_tage</span><span class="op">)</span> <span class="op">~</span> <span class="va">hwz_tage</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="st">"&lt;"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="va">hwz_tage</span><span class="op">)</span> <span class="op">~</span> <span class="fu">get_mean</span><span class="op">(</span><span class="va">hwz_tage</span><span class="op">)</span>,</span>
<span>      .default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">hwz_tage</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      class_id <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">half_life_days</span> <span class="op">&lt;</span> <span class="fl">20</span> <span class="op">~</span> <span class="st">"I"</span>,</span>
<span>        <span class="va">half_life_days</span> <span class="op">&gt;=</span> <span class="fl">20</span> <span class="op">&amp;</span> <span class="va">half_life_days</span> <span class="op">&lt;</span> <span class="fl">200</span> <span class="op">~</span> <span class="st">"II"</span>,</span>
<span>        <span class="va">half_life_days</span> <span class="op">&gt;=</span> <span class="fl">200</span> <span class="op">~</span> <span class="st">"III"</span><span class="op">)</span>,</span>
<span>      class_hlt <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">half_life_days</span> <span class="op">&lt;</span> <span class="fl">20</span> <span class="op">~</span> <span class="st">"&lt; 20 Tage"</span>,</span>
<span>        <span class="va">half_life_days</span> <span class="op">&gt;=</span> <span class="fl">20</span> <span class="op">&amp;</span> <span class="va">half_life_days</span> <span class="op">&lt;</span> <span class="fl">200</span> <span class="op">~</span> <span class="st">"20 - 200 Tage"</span>,</span>
<span>        <span class="va">half_life_days</span> <span class="op">&gt;=</span> <span class="fl">200</span> <span class="op">~</span> <span class="st">"&gt;= 200 Tage"</span><span class="op">)</span>,</span>
<span>      retard <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="va">retardation</span><span class="op">)</span> <span class="op">~</span> <span class="fu">get_mean</span><span class="op">(</span><span class="va">retardation</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">retardation</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1L</span>,</span>
<span>        .default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">retardation</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">half_life_days</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="co"># %&gt;% dplyr::mutate(retard = 1, half_life_days = 0)</span></span>
<span></span>
<span>  <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                       <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">class_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>class_nsubstances <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s, %2d Stoffe)"</span>,</span>
<span>                                        <span class="va">class_id</span>,</span>
<span>                                        <span class="va">class_hlt</span>,</span>
<span>                                        <span class="va">class_nsubstances</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># generate_solute_ids ----------------------------------------------------------</span></span>
<span><span class="va">generate_solute_ids</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">seq_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">seq_end</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">n</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">n</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">seq_end</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">seq_start</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">seq_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">seq_end</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">seq_start</span><span class="op">)</span>,</span>
<span>    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">seq_end</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># generate_periods -------------------------------------------------------------</span></span>
<span><span class="va">generate_periods</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    end <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">10</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">n</span>, <span class="fl">10</span><span class="op">)</span>, <span class="va">n</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">n</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># prepare_files_for_irrig_int --------------------------------------------------</span></span>
<span><span class="va">prepare_files_for_irrig_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">paths</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">`%&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va">`%&gt;%`</span></span>
<span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/createAccessor.html" class="external-link">createAccessor</a></span><span class="op">(</span><span class="va">paths</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">copy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fun</span>, <span class="va">from</span>, <span class="va">to</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/catAndRun.html" class="external-link">catAndRun</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Copying from\n  %s to\n  %s"</span>, <span class="va">from</span>, <span class="va">to</span><span class="op">)</span>,</span>
<span>      <span class="fu">fun</span><span class="op">(</span>path <span class="op">=</span> <span class="va">from</span>, new_path <span class="op">=</span> <span class="va">to</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">dir_exists</a></span><span class="op">(</span><span class="fu">p</span><span class="op">(</span><span class="st">"model_dir"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">copy</span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="va"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">dir_copy</a></span>, from <span class="op">=</span> <span class="fu">p</span><span class="op">(</span><span class="st">"model_dir_org"</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu">p</span><span class="op">(</span><span class="st">"model_dir"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">file_exists</a></span><span class="op">(</span><span class="fu">p</span><span class="op">(</span><span class="st">"model_gui_path"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">copy</span><span class="op">(</span>fun <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="va"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">file_copy</a></span>, from <span class="op">=</span> <span class="fu">p</span><span class="op">(</span><span class="st">"model_gui_path_org"</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu">p</span><span class="op">(</span><span class="st">"model_gui_path"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">model_out_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span></span>
<span>    <span class="fu">p</span><span class="op">(</span><span class="st">"model_dir"</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="st">"\\.out$"</span>,</span>
<span>    full.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">model_out_files</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/delete.html" class="external-link">file_delete</a></span><span class="op">(</span><span class="va">model_out_files</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">soil_depth_cm</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span></span>
<span>    <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="fu">p</span><span class="op">(</span><span class="st">"model_name"</span><span class="op">)</span>, <span class="st">"soil-[0-9]+?m"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="st">"[0-9]"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">soil_depth_cm</span> <span class="op">!=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">soil_profile</span> <span class="op">&lt;-</span> <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/read_profile.html" class="external-link">read_profile</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">profile</span><span class="op">)</span></span>
<span>    <span class="va">profile_extended</span> <span class="op">&lt;-</span> <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/extend_soil_profile.html" class="external-link">extend_soil_profile</a></span><span class="op">(</span></span>
<span>      <span class="va">soil_profile</span><span class="op">$</span><span class="va">profile</span>,</span>
<span>      x_end <span class="op">=</span> <span class="op">-</span><span class="va">soil_depth_cm</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">soil_profile_extended</span> <span class="op">&lt;-</span> <span class="va">soil_profile</span></span>
<span>    <span class="va">soil_profile_extended</span><span class="op">$</span><span class="va">profile</span> <span class="op">&lt;-</span> <span class="va">profile_extended</span></span>
<span>    <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/write_profile.html" class="external-link">write_profile</a></span><span class="op">(</span><span class="va">soil_profile_extended</span>, path <span class="op">=</span> <span class="fu">p</span><span class="op">(</span><span class="st">"profile"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">string_irrig_int</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="fu">p</span><span class="op">(</span><span class="st">"model_dir"</span><span class="op">)</span>, <span class="st">"[0-9][0-9]?days"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Return the string that is used as "irrig_interval"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">string_irrig_int</span>, <span class="st">"\\d+"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">string_irrig_int</span>, <span class="st">"[a-z]+"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># sum_per_interval -------------------------------------------------------------</span></span>
<span><span class="va">sum_per_interval</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">interval</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">`%&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va">`%&gt;%`</span></span>
<span></span>
<span>  <span class="va">data_org</span> <span class="op">&lt;-</span> <span class="va">data</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"groundwater.mmPerDay"</span>, <span class="st">"clearwater.mmPerDay"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cols_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span>  <span class="va">data_summed</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      group <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">date</span>, unit <span class="op">=</span> <span class="va">interval</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co"># Konvertiere date in datetime-Format</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co"># Gruppiere nach Zeitintervallen</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span></span>
<span>      .vars <span class="op">=</span> <span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">cols_sum</span><span class="op">)</span>,</span>
<span>      .funs <span class="op">=</span> <span class="va">sum</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>   <span class="co"># Berechne die Summe für jedes Intervall</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">group</span><span class="op">)</span></span>
<span>  <span class="va">data_org</span><span class="op">[</span>, <span class="va">cols_sum</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">data_org</span><span class="op">[</span><span class="va">data_org</span><span class="op">$</span><span class="va">date</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">data_summed</span><span class="op">$</span><span class="va">date</span>, <span class="va">cols_sum</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">data_summed</span><span class="op">[</span>, <span class="va">cols_sum</span><span class="op">]</span></span>
<span>  <span class="va">data_org</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># get_valid_exe_path -----------------------------------------------------------</span></span>
<span><span class="va">get_valid_exe_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">exe_dir</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">exe_dir</span>, <span class="st">"H1D_CALC.exe"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">exe_dir</span>, <span class="st">"H1D_CALC.exe"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">exe_dir</span><span class="op">)</span></span>
<span>    <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/check_hydrus_exe.html" class="external-link">check_hydrus_exe</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="va">exe_dir</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># inner_function ---------------------------------------------------------------</span></span>
<span><span class="va">inner_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">config</span>, <span class="va">atm_data</span>, <span class="va">soil_columns</span>, <span class="va">helper</span>, <span class="va">root_dir</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">`%&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va">`%&gt;%`</span></span>
<span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="co"># Define constants</span></span>
<span>    <span class="va">IRRIGATION_COLUMNS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"groundwater.mmPerDay"</span>, <span class="st">"clearwater.mmPerDay"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Provide variables from config</span></span>
<span>    <span class="va">extreme_rain</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">extreme_rain</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="cn">NULL</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">config</span><span class="op">$</span><span class="va">extreme_rain</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">tracer</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">treatment</span> <span class="op">==</span> <span class="st">"tracer"</span></span>
<span>    <span class="va">no_retardation</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">retardation</span> <span class="op">==</span> <span class="st">"retardation_no"</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">no_retardation</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">soil_columns</span><span class="op">$</span><span class="va">retard</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">atm</span> <span class="op">&lt;-</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"get_atm"</span><span class="op">)</span><span class="op">(</span><span class="va">atm_data</span>, <span class="va">extreme_rain</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">irrig_only_growing_season</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">atm</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">atm</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>, <span class="va">IRRIGATION_COLUMNS</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">duration_string</span> <span class="op">==</span> <span class="st">"test"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">atm</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">atm</span>, <span class="va">date</span> <span class="op">&gt;=</span> <span class="st">"2017-05-01"</span> <span class="op">&amp;</span> <span class="va">date</span> <span class="op">&lt;=</span> <span class="st">"2018-04-30"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">duration_string</span> <span class="op">==</span> <span class="st">"short"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">atm</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">atm</span>, <span class="va">date</span> <span class="op">&gt;=</span> <span class="st">"2017-05-01"</span> <span class="op">&amp;</span> <span class="va">date</span> <span class="op">&lt;=</span> <span class="st">"2020-04-30"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">atm</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">atm</span>, <span class="va">date</span> <span class="op">&gt;=</span> <span class="st">"2017-05-01"</span> <span class="op">&amp;</span> <span class="va">date</span> <span class="op">&lt;=</span> <span class="st">"2023-12-31"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">days_monthly</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/days_in_month.html" class="external-link">days_in_month</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html" class="external-link">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">atm</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">atm</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">loop_df</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">tracer</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">helper</span><span class="op">(</span><span class="st">"generate_periods"</span><span class="op">)</span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">days_monthly</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu">helper</span><span class="op">(</span><span class="st">"generate_solute_ids"</span><span class="op">)</span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">soil_columns</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/catAndRun.html" class="external-link">catAndRun</a></span><span class="op">(</span></span>
<span>    messageText <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"Running '%s' period for treatment '%s'"</span>,</span>
<span>      <span class="va">extreme_rain</span>,</span>
<span>      <span class="va">config</span><span class="op">$</span><span class="va">treatment</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">loop_df</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="co">#i &lt;- 1L</span></span>
<span>        <span class="op">{</span></span>
<span>          <span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"provide_paths"</span><span class="op">)</span><span class="op">(</span></span>
<span>            <span class="va">root_dir</span>,</span>
<span>            <span class="va">config</span>,</span>
<span>            start <span class="op">=</span> <span class="va">loop_df</span><span class="op">$</span><span class="va">start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>            end <span class="op">=</span> <span class="va">loop_df</span><span class="op">$</span><span class="va">end</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span>          <span class="va">solute_start_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">solute_id_start</span><span class="op">)</span></span>
<span>          <span class="va">solute_end_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">solute_id_end</span><span class="op">)</span></span>
<span>          <span class="va">n_solutes</span> <span class="op">&lt;-</span> <span class="va">solute_end_id</span> <span class="op">-</span> <span class="op">(</span><span class="va">solute_start_id</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>          <span class="va">no_irrig</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">model_dir</span>, <span class="st">"no-irrig"</span><span class="op">)</span></span>
<span>          <span class="va">irrig_int</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">model_dir</span>, <span class="st">"irrig-[0-9][0-9]?days"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">irrig_int</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">irrig_interval</span> <span class="op">&lt;-</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"prepare_files_for_irrig_int"</span><span class="op">)</span><span class="op">(</span><span class="va">paths</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="co"># no-irrigation</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">no_irrig</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">atm</span><span class="op">[</span>, <span class="va">IRRIGATION_COLUMNS</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">irrig_int</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">atm</span> <span class="op">&lt;-</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"sum_per_interval"</span><span class="op">)</span><span class="op">(</span>data <span class="op">=</span> <span class="va">atm</span>, interval <span class="op">=</span> <span class="va">irrig_interval</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="va">days_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">days_monthly</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">days_total</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">c_tops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">indices</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>          <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">atm</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="va">x_min</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="va">days_total</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>          <span class="va">x</span><span class="op">[</span><span class="va">x_min</span><span class="op">:</span><span class="va">days_total</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="va">days_monthly</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>          <span class="va">tib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tib</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="va">indices</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="st">"cTop"</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"cTop%d"</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">indices</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span></span>
<span>          <span class="va">tib</span></span>
<span>        <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">c_tops_sel</span> <span class="op">&lt;-</span> <span class="va">c_tops</span><span class="op">[</span>, <span class="va">paths</span><span class="op">$</span><span class="va">solute_id_start</span><span class="op">:</span><span class="va">paths</span><span class="op">$</span><span class="va">solute_id_end</span><span class="op">]</span></span>
<span></span>
<span>        <span class="va">atm_prep</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">tracer</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu">flextreat.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="../reference/prepare_atmosphere.html">prepare_atmosphere</a></span><span class="op">(</span></span>
<span>            atm <span class="op">=</span> <span class="va">atm</span>,</span>
<span>            conc_irrig_clearwater <span class="op">=</span> <span class="va">c_tops_sel</span>,</span>
<span>            conc_irrig_groundwater <span class="op">=</span> <span class="va">c_tops_sel</span>,</span>
<span>            conc_rain <span class="op">=</span> <span class="va">c_tops_sel</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>          <span class="fu">flextreat.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="../reference/prepare_atmosphere.html">prepare_atmosphere</a></span><span class="op">(</span></span>
<span>            atm <span class="op">=</span> <span class="va">atm</span>,</span>
<span>            conc_irrig_clearwater <span class="op">=</span> <span class="va">soil_columns</span><span class="op">[</span><span class="va">solute_start_id</span><span class="op">:</span><span class="va">solute_end_id</span>, <span class="va">paths</span><span class="op">$</span><span class="va">location</span><span class="op">]</span>,</span>
<span>            conc_irrig_groundwater <span class="op">=</span> <span class="fl">0</span>,</span>
<span>            conc_rain <span class="op">=</span> <span class="fl">0</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="va">n_tsteps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">atm_prep</span><span class="op">)</span></span>
<span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span></span>
<span>          <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/write_atmosphere.html" class="external-link">write_atmosphere</a></span><span class="op">(</span>atm <span class="op">=</span> <span class="va">atm_prep</span><span class="op">)</span>,</span>
<span>          <span class="va">paths</span><span class="op">$</span><span class="va">atmosphere</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="va">selector</span> <span class="op">&lt;-</span> <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/read_selector.html" class="external-link">read_selector</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">selector</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">selector</span><span class="op">$</span><span class="va">time</span><span class="op">$</span><span class="va">tMax</span> <span class="op">&lt;-</span> <span class="va">n_tsteps</span></span>
<span>        <span class="va">selector</span><span class="op">$</span><span class="va">time</span><span class="op">$</span><span class="va">MPL</span> <span class="op">&lt;-</span> <span class="fl">250</span></span>
<span></span>
<span>        <span class="va">selector</span><span class="op">$</span><span class="va">time</span><span class="op">$</span><span class="va">TPrint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_tsteps</span>, <span class="va">n_tsteps</span><span class="op">/</span><span class="va">selector</span><span class="op">$</span><span class="va">time</span><span class="op">$</span><span class="va">MPL</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">selector</span><span class="op">$</span><span class="va">time</span><span class="op">$</span><span class="va">TPrint</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">selector</span><span class="op">$</span><span class="va">time</span><span class="op">$</span><span class="va">TPrint</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="va">solutes_new</span> <span class="op">&lt;-</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"prepare_solute_input"</span><span class="op">)</span><span class="op">(</span></span>
<span>          dat <span class="op">=</span> <span class="va">soil_columns</span><span class="op">[</span><span class="va">solute_start_id</span><span class="op">:</span><span class="va">solute_end_id</span>,<span class="op">]</span>,</span>
<span>          Ks <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">tracer</span><span class="op">)</span> <span class="fl">0</span>, <span class="co"># else NULL</span></span>
<span>          SnkL1 <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">tracer</span><span class="op">)</span> <span class="fl">0</span>, <span class="co"># else NULL</span></span>
<span>          selector <span class="op">=</span> <span class="va">selector</span>,</span>
<span>          diff_w <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          diff_g <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          kd <span class="op">=</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"kd"</span><span class="op">)</span>,</span>
<span>          halftime_to_firstorderrate <span class="op">=</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"halftime_to_firstorderrate"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/write_selector.html" class="external-link">write_selector</a></span><span class="op">(</span><span class="va">solutes_new</span>, <span class="va">paths</span><span class="op">$</span><span class="va">selector</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">hydrus1d</span> <span class="op">&lt;-</span> <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/read_hydrus1d.html" class="external-link">read_hydrus1d</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">hydrus1d</span><span class="op">)</span></span>
<span>        <span class="va">hydrus1d</span><span class="op">$</span><span class="va">Main</span><span class="op">$</span><span class="va">NumberOfSolutes</span> <span class="op">&lt;-</span> <span class="va">n_solutes</span></span>
<span>        <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/write_hydrus1d.html" class="external-link">write_hydrus1d</a></span><span class="op">(</span><span class="va">hydrus1d</span>, <span class="va">paths</span><span class="op">$</span><span class="va">hydrus1d</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">exe_path</span> <span class="op">&lt;-</span> <span class="fu">helper</span><span class="op">(</span><span class="st">"get_valid_exe_path"</span><span class="op">)</span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">exe_dir</span><span class="op">)</span></span>
<span></span>
<span>        <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/run_model.html" class="external-link">run_model</a></span><span class="op">(</span></span>
<span>          exe_path <span class="op">=</span> <span class="va">exe_path</span>,</span>
<span>          model_path <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">model_dir</span>,</span>
<span>          print_output <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="va">atmos</span> <span class="op">&lt;-</span> <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/read_atmosph.html" class="external-link">read_atmosph</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">atmosphere</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co">#atmos$data[names(c_tops)] &lt;- c_tops</span></span>
<span></span>
<span>        <span class="va">atm_default</span> <span class="op">&lt;-</span> <span class="va">atmos</span></span>
<span></span>
<span>        <span class="va">tlevel</span> <span class="op">&lt;-</span> <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/read_tlevel.html" class="external-link">read_tlevel</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">t_level</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">vs_atm</span> <span class="op">&lt;-</span> <span class="fu">flextreat.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="../reference/recalculate_ctop_with_virtualstorage.html">recalculate_ctop_with_virtualstorage</a></span><span class="op">(</span></span>
<span>          atm <span class="op">=</span> <span class="va">atm_default</span><span class="op">$</span><span class="va">data</span>,</span>
<span>          tlevel <span class="op">=</span> <span class="va">tlevel</span>,</span>
<span>          crit_v_top <span class="op">=</span> <span class="op">-</span> <span class="fl">0.05</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="va">atmos</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vs_atm</span><span class="op">$</span><span class="va">df</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">vs_atm</span><span class="op">$</span><span class="va">df</span></span>
<span></span>
<span>        <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">dir_copy</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">model_dir</span>, <span class="va">paths</span><span class="op">$</span><span class="va">model_dir_vs</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">file_copy</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">model_gui_path</span>, <span class="va">paths</span><span class="op">$</span><span class="va">modelvs_gui_path</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">model_vs_out_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">model_dir_vs</span>, pattern <span class="op">=</span> <span class="st">"\\.out$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">model_vs_out_files</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/delete.html" class="external-link">file_delete</a></span><span class="op">(</span><span class="va">model_vs_out_files</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span></span>
<span>          <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/write_atmosphere.html" class="external-link">write_atmosphere</a></span><span class="op">(</span>atm <span class="op">=</span> <span class="va">atmos</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>,</span>
<span>          <span class="va">paths</span><span class="op">$</span><span class="va">atmosphere_vs</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/run_model.html" class="external-link">run_model</a></span><span class="op">(</span></span>
<span>          exe_path <span class="op">=</span> <span class="va">exe_path</span>,</span>
<span>          model_path <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">model_dir_vs</span>,</span>
<span>          print_output <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    dbg <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># helper -----------------------------------------------------------------------</span></span>
<span><span class="va">helper</span> <span class="op">&lt;-</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/createAccessor.html" class="external-link">createAccessor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  get_atm <span class="op">=</span> <span class="va">get_atm</span>,</span>
<span>  generate_solute_ids <span class="op">=</span> <span class="va">generate_solute_ids</span>,</span>
<span>  provide_paths <span class="op">=</span> <span class="va">provide_paths</span>,</span>
<span>  prepare_files_for_irrig_int <span class="op">=</span> <span class="va">prepare_files_for_irrig_int</span>,</span>
<span>  sum_per_interval <span class="op">=</span> <span class="va">sum_per_interval</span>,</span>
<span>  prepare_solute_input <span class="op">=</span> <span class="va">prepare_solute_input</span>,</span>
<span>  halftime_to_firstorderrate <span class="op">=</span> <span class="va">halftime_to_firstorderrate</span>,</span>
<span>  get_valid_exe_path <span class="op">=</span> <span class="va">get_valid_exe_path</span>,</span>
<span>  generate_periods <span class="op">=</span> <span class="va">generate_periods</span>,</span>
<span>  kd <span class="op">=</span> <span class="va">kd</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># extrahiere_letzte_drei_teile -------------------------------------------------</span></span>
<span>  <span class="va">extrahiere_letzte_drei_teile</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pfad</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">pfad</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pf</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Teile den Pfad anhand des Schrägstrichs auf</span></span>
<span>      <span class="va">teile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">pf</span>, <span class="st">"/"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Waehle die letzten drei Teile aus</span></span>
<span>      <span class="va">letzte_drei_teile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">teile</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">letzte_drei_teile</span>, collapse <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="select-substances-define-scenarios">Select Substances &amp; Define Scenarios<a class="anchor" aria-label="anchor" href="#select-substances-define-scenarios"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soil_columns</span> <span class="op">&lt;-</span> <span class="fu">provide_soil_columns</span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/input-data/StofflicheModellRandbedingungen.xlsx"</span>, </span>
<span>                                                        package <span class="op">=</span> <span class="st">"flextreat.hydrus1d"</span><span class="op">)</span></span>
<span>                                     <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 5 warnings in `dplyr::mutate()`.</span></span>
<span><span class="co">#&gt; The first warning was:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In argument: `half_life_days = dplyr::case_when(...)`.</span></span>
<span><span class="co">#&gt; Caused by warning in `hwz_tage %&gt;% stringr::str_remove("&gt;") %&gt;% as.numeric() %&gt;% round(digits = 2)`:</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> NAs introduced by coercion</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Run `dplyr::last_dplyr_warnings()` to see the 4 remaining warnings.</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(class_id)`</span></span>
<span></span>
<span><span class="co">### Select 1 substance for 5 different half life classes defined in this table</span></span>
<span><span class="va">selected_substances</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/input-data/substance_classes.csv"</span>,</span>
<span>                                                   package <span class="op">=</span> <span class="st">"flextreat.hydrus1d"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Rows: </span><span style="color: #0000BB;">5</span> <span style="font-weight: bold;">Columns: </span><span style="color: #0000BB;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Column specification</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Delimiter:</span> ","</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">chr</span> (1): class_label</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">dbl</span> (2): class_id, substance_id</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use `spec()` to retrieve the full column specification for this data.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></span>
<span></span>
<span><span class="va">soil_columns_selected</span> <span class="op">&lt;-</span> <span class="va">soil_columns</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">substanz_nr</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">selected_substances</span><span class="op">$</span><span class="va">substance_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">substanz_nr</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">arg_combis</span> <span class="op">&lt;-</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/expandGrid.html" class="external-link">expandGrid</a></span><span class="op">(</span></span>
<span>  extreme_rain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"wet"</span>, <span class="st">"dry"</span><span class="op">)</span>, <span class="co"># "" needs to be treated as NULL!</span></span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tracer"</span>, <span class="st">"ka"</span>, <span class="st">"o3"</span><span class="op">)</span>, <span class="co"># "tracer" # c("ka", "o3")</span></span>
<span>  scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"soil-"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"m_irrig-%02ddays"</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  irrig_only_growing_season <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  duration_string <span class="op">=</span> <span class="st">"long"</span>, <span class="co">#c("short", "long"),</span></span>
<span>  retardation_scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"retardation_yes"</span>, <span class="st">"retardation_no"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="modelling">Modelling<a class="anchor" aria-label="anchor" href="#modelling"></a>
</h2>
<div class="section level3">
<h3 id="scenario-creation">Scenario Creation<a class="anchor" aria-label="anchor" href="#scenario-creation"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">arg_combis</span> <span class="op">&lt;-</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/expandGrid.html" class="external-link">expandGrid</a></span><span class="op">(</span></span>
<span>  extreme_rain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"wet"</span>, <span class="st">"dry"</span><span class="op">)</span>, <span class="co"># "" needs to be treated as NULL!</span></span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ka"</span>, <span class="st">"o3"</span><span class="op">)</span>, <span class="co"># "tracer" # c("ka", "o3")</span></span>
<span>  scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"soil-"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"m_irrig-%02ddays"</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  irrig_only_growing_season <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  duration_string <span class="op">=</span> <span class="st">"long"</span>, <span class="co">#c("short", "long"),</span></span>
<span>  retardation_scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"retardation_yes"</span>, <span class="st">"retardation_no"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This results in 144 scenarios, which are listed in detail in the
table below.</p>
<p></p>
<div class="datatables html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:auto;"></div> <script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144"],["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","wet","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry","dry"],["ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","ka","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3","o3"],["soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-1m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-2m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-3m_irrig-01days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-1m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-2m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days","soil-3m_irrig-10days"],[true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false,true,true,false,false],["long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long","long"],["retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no","retardation_yes","retardation_no"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>extreme_rain<\/th>\n      <th>treatment<\/th>\n      <th>scenario<\/th>\n      <th>irrig_only_growing_season<\/th>\n      <th>duration_string<\/th>\n      <th>retardation_scenario<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"extreme_rain","targets":1},{"name":"treatment","targets":2},{"name":"scenario","targets":3},{"name":"irrig_only_growing_season","targets":4},{"name":"duration_string","targets":5},{"name":"retardation_scenario","targets":6}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level3">
<h3 id="run-the-model">Run the Model<a class="anchor" aria-label="anchor" href="#run-the-model"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">atm_data</span> <span class="op">&lt;-</span> <span class="fu">flextreat.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="../reference/prepare_atmosphere_data.html">prepare_atmosphere_data</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Convert model scenarios into valid data structure for HYDRUs-1D modelling</span></span>
<span>  <span class="va">configs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">arg_combis</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">arg_combis</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># system.time({</span></span>
<span>  <span class="co"># #Sequential loop</span></span>
<span>  <span class="co"># for (config in configs) {</span></span>
<span>  <span class="co">#   config &lt;- configs[[1L]]</span></span>
<span>  <span class="co">#   inner_function(</span></span>
<span>  <span class="co">#     config = config,</span></span>
<span>  <span class="co">#     atm_data = atm_data,</span></span>
<span>  <span class="co">#     soil_columns = soil_columns,</span></span>
<span>  <span class="co">#     helper = helper,</span></span>
<span>  <span class="co">#     root_dir = root_dir</span></span>
<span>  <span class="co">#   )</span></span>
<span>  <span class="co"># }</span></span>
<span>  <span class="co"># })</span></span>
<span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span>expr <span class="op">=</span> <span class="op">{</span></span>
<span>  <span class="co"># Parallel loop</span></span>
<span>  <span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span></span>
<span>    cl <span class="op">=</span> <span class="va">cl</span>,</span>
<span>    X <span class="op">=</span> <span class="va">configs</span>,</span>
<span>    fun <span class="op">=</span> <span class="va">inner_function</span>,</span>
<span>    atm_data <span class="op">=</span> <span class="va">atm_data</span>,</span>
<span>    soil_columns <span class="op">=</span> <span class="va">soil_columns</span>,</span>
<span>    helper <span class="op">=</span> <span class="va">helper</span>,</span>
<span>    root_dir <span class="op">=</span> <span class="va">root_dir</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="post-processing">Post-Processing<a class="anchor" aria-label="anchor" href="#post-processing"></a>
</h2>
<div class="section level3">
<h3 id="prepare-solutes-summary">Prepare Solutes Summary<a class="anchor" aria-label="anchor" href="#prepare-solutes-summary"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">#scenarios_solutes &lt;- paste0(scenarios, "_soil-column")</span></span>
<span>  <span class="va">scenarios_solutes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ablauf_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"o3"</span>, <span class="st">"ka"</span><span class="op">)</span>, <span class="st">"_median"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">scenario_dirs</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span></span>
<span>    path <span class="op">=</span>   <span class="va">root_dir</span>,</span>
<span>    recurse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    regexp <span class="op">=</span> <span class="st">"retardation_no.*vs$"</span>,</span>
<span>    <span class="co">#regexp = "irrig-period_status-quo/long/retardation_no.*vs$",</span></span>
<span>    <span class="co">#regexp = "irrig-period_status-quo/long/retardation_no/ablauf_ka_median_soil-1m_irrig-01days_soil-column_0105.*vs$",</span></span>
<span>    type <span class="op">=</span> <span class="st">"directory"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Set up parallel plan</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span>expr <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="co"># future::plan(future::multisession)</span></span>
<span></span>
<span>    <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_sapply</a></span><span class="op">(</span><span class="va">scenario_dirs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">scenario_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>      <span class="va">solutes_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">scenarios_solutes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">scenario</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">solute_files</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">scenario_dir</span>,</span>
<span>                                   regexp <span class="op">=</span> <span class="st">"solute\\d\\d?.out"</span>,</span>
<span>                                   recurse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">solute_files</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">solutes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">solute_files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu">kwb.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.hydrus1d/man/read_solute.html" class="external-link">read_solute</a></span><span class="op">(</span><span class="va">file</span>, dbg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">}</span><span class="op">)</span>, nm <span class="op">=</span> <span class="va">solute_files</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"path"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">solute_files_df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">solute_files</span>,</span>
<span>                                          model_solute_id <span class="op">=</span> <span class="va">path</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"[0-9][0-9]?"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                          soilcolumn_id_start <span class="op">=</span> <span class="va">path</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"[0-9]{4}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                          soilcolumn_id_end <span class="op">=</span> <span class="va">path</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"[0-9]{4}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                          soil_column_id <span class="op">=</span> <span class="va">soilcolumn_id_start</span> <span class="op">+</span> <span class="va">model_solute_id</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">soil_columns</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>soil_column_id <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">solutes</span>, <span class="va">solute_files_df</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span>, nm <span class="op">=</span> <span class="va">scenarios_solutes</span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">solutes_df</span> <span class="op">&lt;-</span> <span class="va">solutes_list</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"scenario"</span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">solutes_df_stats</span> <span class="op">&lt;-</span> <span class="va">solutes_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"scenario"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>scen <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span>, <span class="st">"_soil-column.*"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">scen</span>,<span class="va">substanz_nr</span>, <span class="va">substanz_name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>sum_cv_top <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sum_cv_top</span><span class="op">)</span>,</span>
<span>                         sum_cv_bot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sum_cv_bot</span><span class="op">)</span>,</span>
<span>                         cv_ch1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">cv_ch1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mass_balance_error_percent <span class="op">=</span> <span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">sum_cv_top</span> <span class="op">+</span> <span class="va">cv_ch1</span> <span class="op">+</span> <span class="va">sum_cv_bot</span><span class="op">)</span><span class="op">/</span><span class="va">sum_cv_top</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">mass_balance_error_percent</span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">solutes_df_stats</span><span class="op">$</span><span class="va">soil</span> <span class="op">&lt;-</span> <span class="va">solutes_df_stats</span><span class="op">$</span><span class="va">sum_cv_top</span> <span class="op">+</span> <span class="va">solutes_df_stats</span><span class="op">$</span><span class="va">sum_cv_bot</span> <span class="op">+</span> <span class="va">solutes_df_stats</span><span class="op">$</span><span class="va">cv_ch1</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">solutes_df</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">scenario_dir</span>, <span class="st">"solutes.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="fu">openxlsx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/write.xlsx.html" class="external-link">write.xlsx</a></span><span class="op">(</span><span class="va">solutes_df_stats</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">scenario_dir</span>, <span class="st">"hydrus_scenarios.xlsx"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="co"># Close the parallel plan</span></span>
<span>    <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-substance-load-plots">Create Substance Load Plots<a class="anchor" aria-label="anchor" href="#create-substance-load-plots"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"retardation_%s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yes"</span>, <span class="st">"no"</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">retardation_short</span><span class="op">)</span> <span class="op">{</span> </span>
<span>   </span>
<span>  <span class="va">soil_columns_plot</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">retardation_short</span> <span class="op">==</span> <span class="st">"retardation_yes"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">soil_columns</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">soil_columns</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>retard <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">scenario_dirs</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span></span>
<span>    path <span class="op">=</span>   <span class="va">root_dir</span>,</span>
<span>    recurse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    regexp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s.*vs/hydrus_scenarios.xlsx$"</span>, <span class="va">retardation_short</span><span class="op">)</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"file"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="va">res_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">scenario_dirs</span><span class="op">)</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">scenario_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">readxl</span><span class="fu">::</span><span class="fu">read_excel</span><span class="op">(</span><span class="va">scenario_dir</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">load_default_paths</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%sirrig-period_status-quo"</span>, <span class="va">root_dir</span><span class="op">)</span>,</span>
<span>                                   recurse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                   regexp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"long/%s/ablauf_ka_median_soil-2m_irrig-10days_.*vs/hydrus_scenarios.xlsx"</span>,  <span class="va">retardation_short</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="va">load_default</span> <span class="op">&lt;-</span>  <span class="va">res_stats</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"path"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">path</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">load_default_paths</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">path</span>, <span class="op">-</span> <span class="va">scen</span>, <span class="op">-</span> <span class="va">mass_balance_error_percent</span>, <span class="op">-</span> <span class="va">soil</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">load_default</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"default_"</span>,   <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">load_default</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">load_default_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">load_default</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="va">res_stats_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">res_stats</span>, .id <span class="op">=</span> <span class="st">"path"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>retardation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  irrigation_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">path</span>, <span class="op">-</span> <span class="va">mass_balance_error_percent</span>, <span class="op">-</span> <span class="va">soil</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">scen</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"treatment"</span>, <span class="st">"soil_depth_irrig"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"n_s"</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%sn"</span>, <span class="va">treatment</span><span class="op">)</span>,</span>
<span>                  soil_depth_irrig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"s%s"</span>, <span class="va">soil_depth_irrig</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">soil_depth_irrig</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"soil_depth"</span>, <span class="st">"irrigation_intervall"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>duration_irrigperiod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">duration</span>, <span class="st">"_"</span>, <span class="va">irrigation_period</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="va">substances_per_class</span> <span class="op">&lt;-</span> <span class="va">soil_columns</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">class_id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">res_stats_df_class</span> <span class="op">&lt;-</span> <span class="va">res_stats_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">soil_columns</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">substanz_name</span>, <span class="va">class_id</span>, <span class="va">class_label</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">scen</span>, <span class="va">treatment</span>, <span class="va">soil_depth</span>, <span class="va">irrigation_intervall</span>, <span class="va">duration</span>, <span class="va">irrigation_period</span>, <span class="va">class_id</span>, <span class="va">class_label</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sum_cv_top</span>, <span class="va">sum_cv_bot</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     number_of_substances <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>scenario_label <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_ka_median_soil-2m_irrig-10days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_status-quo"</span> <span class="op">~</span> <span class="st">"Status Quo"</span>,</span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_ka_median_soil-2m_irrig-10days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long_wet"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_status-quo"</span> <span class="op">~</span> <span class="st">"Klima, feucht"</span>,</span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_ka_median_soil-2m_irrig-10days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long_dry"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_status-quo"</span> <span class="op">~</span> <span class="st">"Klima, trocken"</span>,</span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_ka_median_soil-2m_irrig-10days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_growing-season"</span> <span class="op">~</span> <span class="st">"Bewässerung (nur Mai-Sep)"</span>,</span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_o3_median_soil-2m_irrig-10days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_status-quo"</span> <span class="op">~</span> <span class="st">"Ozone-UV"</span>,</span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_ka_median_soil-1m_irrig-10days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_status-quo"</span> <span class="op">~</span> <span class="st">"Boden, 1 m"</span>,</span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_ka_median_soil-3m_irrig-10days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_status-quo"</span> <span class="op">~</span> <span class="st">"Boden, 3 m"</span>,</span>
<span>       <span class="va">scen</span> <span class="op">==</span> <span class="st">"ablauf_ka_median_soil-2m_irrig-01days"</span> <span class="op">&amp;</span> <span class="va">duration</span> <span class="op">==</span> <span class="st">"long"</span> <span class="op">&amp;</span> <span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"irrig-period_status-quo"</span> <span class="op">~</span> <span class="st">"Bewässerungsintervall, 1 Tag"</span>,</span>
<span>       .default <span class="op">=</span> <span class="st">""</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">res_stats_df_class_selected</span> <span class="op">&lt;-</span> <span class="va">res_stats_df_class</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">scenario_label</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">load_gw</span> <span class="op">&lt;-</span> <span class="va">res_stats_df_class_selected</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">scenario_label</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>total_sum_cv_bot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sum_cv_bot</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">load_default_per_class</span> <span class="op">&lt;-</span> <span class="va">res_stats_df_class_selected</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">scenario_label</span> <span class="op">==</span> <span class="st">"Status Quo"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">class_label</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>default_class_sum_cv_top <span class="op">=</span> <span class="va">sum_cv_top</span>,</span>
<span>                  default_class_sum_cv_bot <span class="op">=</span> <span class="va">sum_cv_bot</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>default_class_sum_cv_top <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">default_class_sum_cv_top</span><span class="op">)</span>,</span>
<span>                     default_class_sum_cv_bot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">default_class_sum_cv_top</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">class_label</span>, <span class="va">default_class_sum_cv_top</span>, <span class="va">default_class_sum_cv_bot</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span>  <span class="va">load_per_scenario_and_class</span> <span class="op">&lt;-</span> <span class="va">res_stats_df_class</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">scenario_label</span>, <span class="va">class_label</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>class_sum_cv_top <span class="op">=</span> <span class="va">sum_cv_top</span>,</span>
<span>                  class_sum_cv_bot <span class="op">=</span> <span class="va">sum_cv_bot</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>class_sum_cv_top <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">class_sum_cv_top</span><span class="op">)</span>,</span>
<span>                     class_sum_cv_bot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">class_sum_cv_bot</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">scenario_label</span>, <span class="va">class_label</span>, <span class="va">class_sum_cv_top</span>, <span class="va">class_sum_cv_bot</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">load_per_scenario</span> <span class="op">&lt;-</span> <span class="va">res_stats_df_class</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">scenario_label</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>scenario_sum_cv_top <span class="op">=</span> <span class="va">sum_cv_top</span>,</span>
<span>                  scenario_sum_cv_bot <span class="op">=</span> <span class="va">sum_cv_bot</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>scenario_sum_cv_top <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">scenario_sum_cv_top</span><span class="op">)</span>,</span>
<span>                     scenario_sum_cv_bot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">scenario_sum_cv_bot</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">scenario_label</span>, <span class="va">scenario_sum_cv_top</span>, <span class="va">scenario_sum_cv_bot</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">x_desired_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Status Quo"</span>,</span>
<span>                         <span class="st">"Boden, 1 m"</span>,</span>
<span>                         <span class="st">"Boden, 3 m"</span>,</span>
<span>                         <span class="st">"Klima, trocken"</span>,</span>
<span>                         <span class="st">"Klima, feucht"</span>,</span>
<span>                         <span class="st">"Bewässerungsintervall, 1 Tag"</span>,</span>
<span>                         <span class="st">"Bewässerung (nur Mai-Sep)"</span>,</span>
<span>                         <span class="st">"Ozone-UV"</span></span>
<span>                         <span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">gg0</span> <span class="op">&lt;-</span> <span class="va">res_stats_df_class_selected</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">load_default_sum</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span> <span class="va">load_per_scenario_and_class</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>percent_sum_cv_bot <span class="op">=</span>  <span class="va">class_sum_cv_bot</span> <span class="op">/</span> <span class="va">default_sum_cv_top</span>,</span>
<span>                    percent_sum_cv_top <span class="op">=</span>  <span class="va">class_sum_cv_top</span> <span class="op">/</span> <span class="va">default_sum_cv_top</span>,</span>
<span>                    percent_gw <span class="op">=</span> <span class="va">percent_sum_cv_bot</span><span class="op">/</span><span class="va">percent_sum_cv_top</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"percent_sum"</span><span class="op">)</span>,</span>
<span>                          names_to <span class="op">=</span> <span class="st">"variable"</span>,</span>
<span>                          values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">variable</span> <span class="op">==</span> <span class="st">"percent_sum_cv_bot"</span> <span class="op">~</span> <span class="st">"Grundwasser"</span>,</span>
<span>        <span class="va">variable</span> <span class="op">==</span> <span class="st">"percent_sum_cv_top"</span> <span class="op">~</span> <span class="st">"Boden"</span>,</span>
<span>        .default <span class="op">=</span> <span class="va">variable</span><span class="op">)</span>,</span>
<span>        perc_gw <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"Grundwasser"</span>,</span>
<span>                                 <span class="fl">100</span><span class="op">*</span><span class="va">percent_gw</span>,</span>
<span>                                 <span class="fl">100</span> <span class="op">-</span> <span class="fl">100</span><span class="op">*</span><span class="va">percent_gw</span><span class="op">)</span><span class="co">#,</span></span>
<span>        <span class="co"># value = dplyr::if_else(variable == "Grundwasser",</span></span>
<span>        <span class="co">#                          - value,</span></span>
<span>        <span class="co">#                          value)</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">load_gw</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">load_per_scenario</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">class_label</span>,</span>
<span>                                   group <span class="op">=</span> <span class="va">variable</span>,</span>
<span>                                   y <span class="op">=</span> <span class="va">value</span>,</span>
<span>                                   x <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu">fct_relevel</span><span class="op">(</span><span class="va">scenario_label</span>, <span class="va">x_desired_order</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Szenario"</span>,</span>
<span>                    y <span class="op">=</span> <span class="st">"Gesamtfracht normiert auf den Status-Quo (%)"</span>,</span>
<span>                    fill <span class="op">=</span> <span class="st">"Stoffeintrag"</span>,</span>
<span>                    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">retardation_short</span> <span class="op">==</span> <span class="st">"retardation_no"</span>,</span>
<span>                                   <span class="st">"ohne Retardation"</span>,</span>
<span>                                   <span class="st">"mit Retardation"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span>, scales <span class="op">=</span> <span class="st">"fixed"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="co">#ggplot2::scale_fill_manual(values = reversed_palette) +</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.05</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">value</span><span class="op">*</span><span class="fl">100</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                                                             <span class="st">""</span>,</span>
<span>                                                             <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%2.1f %%"</span>,  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">value</span><span class="op">*</span><span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         position <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_stack.html" class="external-link">position_stack</a></span><span class="op">(</span>vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                         size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Extrahiere die Standardfarben von ggplot2</span></span>
<span>    <span class="va">default_colors</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot_build.html" class="external-link">ggplot_build</a></span><span class="op">(</span><span class="va">gg0</span><span class="op">)</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">fill</span></span>
<span>    </span>
<span>    <span class="co"># Kehre die Reihenfolge der Farben um</span></span>
<span>    <span class="va">reversed_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">default_colors</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">gg0</span> <span class="op">&lt;-</span> <span class="va">gg0</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">reversed_colors</span><span class="op">)</span></span>
<span>    </span>
<span>   </span>
<span>     <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"stoffeintrag_%s.png"</span>, <span class="va">retardation_short</span><span class="op">)</span>, </span>
<span>        width <span class="op">=</span> <span class="fl">1200</span>, </span>
<span>        height <span class="op">=</span> <span class="fl">800</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gg0</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-conservative-tracer-plots">Create Conservative Tracer Plots<a class="anchor" aria-label="anchor" href="#create-conservative-tracer-plots"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">model_paths</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span></span>
<span>    path <span class="op">=</span>  <span class="va">root_dir</span> ,</span>
<span>    recurse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    regexp <span class="op">=</span> <span class="st">"tracer$"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"directory"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span>  <span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"soil-"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"m_irrig-%02ddays"</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### read traveltimes sequential</span></span>
<span>  <span class="co"># system.time(</span></span>
<span>  <span class="co"># traveltimes_list &lt;- lapply(model_paths, function(model_path) {</span></span>
<span>  <span class="co">#   setNames(nm = (scenarios), lapply(scenarios, function(scenario) {</span></span>
<span>  <span class="co">#     try({</span></span>
<span>  <span class="co">#       message(sprintf("Scenario: %s", scenario))</span></span>
<span>  <span class="co">#       solute_files &lt;- fs::dir_ls(</span></span>
<span>  <span class="co">#         path = model_path,</span></span>
<span>  <span class="co">#         recurse = TRUE,</span></span>
<span>  <span class="co">#         regexp = sprintf("tracer_%s_.*vs/solute\\d\\d?.out", scenario)</span></span>
<span>  <span class="co">#       )</span></span>
<span>  <span class="co">#       flextreat.hydrus1d::get_traveltimes(solute_files, dbg = TRUE)</span></span>
<span>  <span class="co">#     })</span></span>
<span>  <span class="co">#   }))</span></span>
<span>  <span class="co"># }))</span></span>
<span></span>
<span></span>
<span></span>
<span>  <span class="co">### read traveltimes in parallel</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Set up parallel plan</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span>expr <span class="op">=</span> <span class="op">{</span></span>
<span>  <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/multisession.html" class="external-link">multisession</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">traveltimes_list</span> <span class="op">&lt;-</span> <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">model_paths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">model_path</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="op">(</span><span class="va">scenarios</span><span class="op">)</span>, <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">scenarios</span>, <span class="kw">function</span><span class="op">(</span><span class="va">scenario</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Scenario: %s"</span>, <span class="va">scenario</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">solute_files</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span></span>
<span>          path <span class="op">=</span> <span class="va">model_path</span>,</span>
<span>          recurse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          regexp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"tracer_%s_.*vs/solute\\d\\d?.out"</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu">flextreat.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="../reference/get_traveltimes.html">get_traveltimes</a></span><span class="op">(</span><span class="va">solute_files</span>, dbg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Close the parallel plan</span></span>
<span>  <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span>
<span>  <span class="va">traveltimes_list_backup</span> <span class="op">&lt;-</span>  <span class="va">traveltimes_list</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">traveltimes_list</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s"</span>, <span class="fu">extrahiere_letzte_drei_teile</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">traveltimes_list</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">htmlwidgets</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmlwidgets/man/saveWidget.html" class="external-link">saveWidget</a></span><span class="op">(</span><span class="fu">flextreat.hydrus1d</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_traveltimes.html">plot_traveltimes</a></span><span class="op">(</span><span class="va">traveltimes_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                                                 title <span class="op">=</span> <span class="va">label</span> ,</span>
<span>                                                                 ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">650</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"traveltimes_%s.html"</span>, <span class="va">label</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">jpeg</a></span><span class="op">(</span>filename <span class="op">=</span> <span class="st">"verweilzeiten.jpeg"</span>, height <span class="op">=</span> <span class="fl">500</span>, width <span class="op">=</span> <span class="fl">1200</span>, quality <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="co">#pdff &lt;- "traveltimes_all_percent_de.pdf"</span></span>
<span>    <span class="co">#kwb.utils::preparePdf(pdff)</span></span>
<span></span>
<span>    <span class="va">traveltimes_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">traveltimes_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">sublist</span><span class="op">)</span> <span class="va">sublist</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"scenario_main_raw"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        scenario_name <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="va">model_name</span>, <span class="st">"_soil-column_.*vs$"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="st">"tracer_"</span><span class="op">)</span>,</span>
<span>        scenario_main <span class="op">=</span>  <span class="va">scenario_main_raw</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">extrahiere_letzte_drei_teile</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="st">"_tracer"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="st">"irrig-period_"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="st">"_long"</span><span class="op">)</span>,</span>
<span>        quarter <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/quarter.html" class="external-link">quarter</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        soil_depth <span class="op">=</span>  <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">scenario_name</span>, <span class="st">"soil-.*m"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="st">"soil-|m"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        irrigation_interval <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">scenario_name</span>, pattern <span class="op">=</span> <span class="st">"irrig.*"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="st">"[0-9]+"</span><span class="op">)</span>,</span>
<span>        label_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Bo%sBi%s"</span>, <span class="va">soil_depth</span>, <span class="va">irrigation_interval</span><span class="op">)</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">scenario_main</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"irrigation_period"</span>, <span class="st">"climate"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>climate <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">climate</span> <span class="op">==</span> <span class="st">"wet"</span> <span class="op">~</span> <span class="st">"N835"</span>,</span>
<span>                                               <span class="va">climate</span> <span class="op">==</span> <span class="st">"dry"</span> <span class="op">~</span> <span class="st">"N380"</span>,</span>
<span>                                               .default <span class="op">=</span> <span class="st">"N606"</span><span class="op">)</span>,</span>
<span>                    irrigation_period <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">irrigation_period</span> <span class="op">==</span> <span class="st">"growing-season"</span>, <span class="st">"B289"</span>, <span class="st">"B405"</span><span class="op">)</span>,</span>
<span>                    label_legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s%s"</span>, <span class="va">climate</span>, <span class="va">irrigation_period</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">scenario_base_median</span> <span class="op">&lt;-</span> <span class="va">traveltimes_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>        <span class="va">scenario_name</span> <span class="op">==</span> <span class="st">"soil-2m_irrig-10days"</span>,</span>
<span>        <span class="va">scenario_main</span> <span class="op">==</span> <span class="st">"status-quo"</span>,</span>
<span>        <span class="va">percentiles</span> <span class="op">==</span> <span class="fl">0.5</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">time_top</span>, <span class="op">-</span> <span class="va">time_bot</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time_diff_base <span class="op">=</span> <span class="va">time_diff</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">traveltimes_bp</span> <span class="op">&lt;-</span> <span class="va">traveltimes_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">percentiles</span> <span class="op">==</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">scenario_base_median</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"month_id"</span>, <span class="st">"time_diff_base"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>percentiles <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time_diff_percent <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">time_diff</span> <span class="op">-</span> <span class="va">time_diff_base</span><span class="op">)</span> <span class="op">/</span> <span class="va">time_diff_base</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_diff_percent</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Plotting ---------------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="va">y_lim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">350</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">tt_bp_percent</span> <span class="op">&lt;-</span> <span class="va">traveltimes_bp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">label_x</span><span class="op">)</span>, <span class="va">time_diff_percent</span><span class="op">)</span>,</span>
<span>                                 y <span class="op">=</span> <span class="va">time_diff_percent</span>,</span>
<span>                                 col <span class="op">=</span> <span class="va">label_legend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outliers <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># ggplot2::geom_jitter(position = ggplot2::position_jitterdodge(</span></span>
<span>    <span class="co">#   jitter.width = 0.1,</span></span>
<span>    <span class="co">#   dodge.width = 0.75),</span></span>
<span>    <span class="co">#   alpha = 0.6) +</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">y_lim</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mittlere Verweilzeit (%) im Vergleich zu Status Quo"</span>,</span>
<span>                  x <span class="op">=</span> <span class="st">"Bodenmächtigkeit (m) und Bewässerungsintervall (Tage)"</span>,</span>
<span>                  col <span class="op">=</span> <span class="st">"Niederschlag und Bew\u00E4sserung (mm/Jahr)"</span>,</span>
<span>                  title <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span><span class="co">#legend.position=c(0.85,0.85),</span></span>
<span>                   legend.box.just <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>                   legend.direction <span class="op">=</span> <span class="st">"vertical"</span>,</span>
<span>                   legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                   legend.margin <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   legend.text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,<span class="co"># face = "bold"),  # Größer und dick</span></span>
<span>                   legend.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                   axis.text.x <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                   axis.text.y <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># Größer und dick</span></span>
<span>                   axis.title.x <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># Größer und dick</span></span>
<span>                   axis.title.y <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                   plot.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">17</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                   plot.subtitle <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="co">#,   # Größer und dick</span></span>
<span>                   <span class="co">#plot.subtitle = ggplot2::element_text(size = 14, face = "bold")</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tt_bp_percent</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#kwb.utils::finishAndShowPdf(pdff)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.kompetenz-wasser.de/en/ueber-uns/team/michael-rustler" class="external-link">Michael Rustler</a>, <a href="https://www.kompetenz-wasser.de/en/forschung/projekte/flextreat" class="external-link"><img src="https://bmbf-wave.de/Verbundprojekte+nach+Themenfeldern/Kommunales+Abwasser/FlexTreat-height-394-width-1389/_/Flextreat-Logo-300dpi.png" alt="Project FLexTreat" height="24"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
